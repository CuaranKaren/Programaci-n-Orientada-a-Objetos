import board
import adafruit_dht

# --- EXCEPCIONES PERSONALIZADAS ---
class SensorError(Exception):
    pass

class HardwareReadError(SensorError):
    def __init__(self, message="Fallo de lectura en hardware (NoneType/CRC)"):
        self.message = message
        super().__init__(self.message)

class CriticalTempError(SensorError):
    def __init__(self, temp, threshold):
        self.temp = temp
        self.message = f"üî• ALERTA T√âRMICA: {temp}¬∞C supera el l√≠mite de {threshold}¬∞C"
        super().__init__(self.message)

# --- CLASE MODELO ---
class MonitorModel:
    def __init__(self, pin_sensor_gpio=4, temp_threshold=30.0):
        # Configuraci√≥n del sensor DHT11 en GPIO 4
        self.sensor = adafruit_dht.DHT11(board.D4)
        self.threshold = temp_threshold

    def read_sensor(self):
        try:
            temp = self.sensor.temperature
            humidity = self.sensor.humidity
            
            # Validaci√≥n de Hardware
            if temp is None or humidity is None:
                raise HardwareReadError()

            # Validaci√≥n de Negocio (Temperatura)
            if temp > self.threshold:
                raise CriticalTempError(temp, self.threshold)

            return {"temp": temp, "hum": humidity}

        except RuntimeError as error:
            # Error com√∫n de la librer√≠a adafruit (timeouts)
            raise HardwareReadError(f"Error interno del sensor: {error}")
        except Exception as e:
            if isinstance(e, (HardwareReadError, CriticalTempError)):
                raise e
            raise SensorError(f"Error desconocido: {e}")
